#!/bin/bash -ex

###Config Vars

# look for a "stable" or "latest" zip or tar
#GHOST_URL="https://ghost.org/zip/ghost-0.7.8.zip"
GHOST_URL="https://ghost.org/zip/ghost-latest.zip"
# open to alternative targets
GHOST_DIR="/opt/ghost"


# Get Ghost (Stable 0.7.8)
wget $GHOST_URL -O /tmp/ghost.zip
unzip /tmp/ghost.zip -d $GHOST_DIR/

#Set node version (0.10.40 confirmed to work); open to higher version
n 0.10.40

# according to documented install
chown -R node:node /opt/ghost/
cd $GHOST_DIR && su -c "npm install --production" node
cd $GHOST_DIR && su -c "forever start index.js" node



#nginx considerations
#ghost runs on 2368. Proxy to port 80 and port 443 (SSL/TLS)
ln -s /etc/nginx/sites-available/ghost /etc/nginx/sites-enabled/ghost

cd $GHOST_DIR && su -c "forever stop index.js" node
chown -R node:node $GHOST_DIR

# pm2
cd $GHOST_DIR && su -c "NODE_ENV=production pm2 start --name 'ghost' index.js" node

# remove conflicting nginx site (web-control)
rm /etc/nginx/sites-enabled/nodejs
